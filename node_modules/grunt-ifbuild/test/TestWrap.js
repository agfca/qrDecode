var buildCommand = require("../lib");
var utils = require("../lib/utils");
var path = require('path');
var fileUtils = require('file-utils');

var blockFile = new buildCommand.blockFile(path.join(__dirname, './test.html') , null);

if(blockFile && blockFile.blocks.length){
    var blocks = blockFile.blocks;
    for(var i=0 ; i<blocks.length; i++){
         var block = blocks[i];
         var Blockprocessor = buildCommand.getBlockProcessor(block.blockType); //得到当前块的处理器
          (new Blockprocessor()).processRun(block , {appDir:"",destPath:""});
    }
    var htmlContent = blockFile.content;
    for(var i=0 ; i<blockFile.blocks.length; i++){
        var block = blockFile.blocks[i];
        var replaceBlock = block.blockOuterContent;
        var changedBlock = block.changedContent;
        var  blockType = block.blockType;    //块类型、js/css/requirejs
        var  deviceType = block.blockDevice; //设备类型
        if(typeof changedBlock === 'undefined'){
              changedBlock = replaceBlock;
        }
        htmlContent = htmlContent.replace(replaceBlock , utils.wrapScript(changedBlock , blockType , deviceType));
    }
    fileUtils.write(path.join(__dirname, './test_out.html') , htmlContent);
}