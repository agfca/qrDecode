'use strict';

var path = require('path');
var fileUtils = require('file-utils');
var TemplateTools = function(options) {

	var options = typeof options == 'undefined' ? {} : options;
	
	//转换为JS
	var html2js = function(pHtml , basename , moduleName , preSpace){
		
		//删除注释和空行
		var matchs = pHtml.match(/<!--(.|\n|\r)*?-->/ig);
		if(typeof matchs != 'undefined' && matchs != null){
			matchs.forEach(function(match){
				pHtml = pHtml.replace(match,'');
			});
		}

		var matchs = pHtml.match(/^\s*[\r\n]*/ig);
		if(typeof matchs != 'undefined' && matchs != null){
			matchs.forEach(function(match){
				pHtml = pHtml.replace(match,'');
			});
		}


		var result = pHtml;
		var endType = result.indexOf('\r\n') < 0 ? '\n' : '\r\n';
		var ret =  preSpace+ "var "+basename+" = [];"+endType;
		result.split(endType).forEach(function(line){
			if(line != ''){
				line = replaceIncludeFile(line , moduleName);
				line = line.replace(/\\/g,"\\\\").replace(/\'/g,"\\\'").replace(/\"/g,"\\\"");
				ret += preSpace+(basename+'.push(\''+ line.replace(endType ,'') +'\')'+endType);
			}
		})
		return ret;
	}
	
	var replaceIncludeFile = function(line , moduleName){
			var regx = /({{\s*include\s*['|"]+)([^'|"]*)(['|"]+.*)/gi;
			var ret = line.replace(regx , function(match , start , content , end , offset , str){
		        return start + content + end;
		    })
			return ret;
	}

	this.compile = function(moduleName , files , basepath){
			
	 		var outfile = options.outfile;
	 		var fileList = typeof files === 'string' ? [files] : files;
	 		var retContent = [];
	 		var packageJson = fileUtils.readJSON('./package.json');
	 		var curVersion = packageJson.version;
	 		curVersion = (curVersion == '' ? curVersion : '#'+curVersion);
	 		retContent.push('define("'+moduleName+curVersion+'/template" , ["artTemplate#3.0.3"] , function(artTemplate){');
	 		retContent.push('   artTemplate = new artTemplate();');
	 	    retContent.push('   var _template = {};');
	 	    
	 		fileList.forEach(function(file){

                var fileName = file.replace(basepath,'').replace(/\\/g , '_').replace(/\//g,'_');
                var extName = path.extname(file);
	 			var baseName = fileName.indexOf(extName) < 0 ? fileName : fileName.substring(0 , fileName.indexOf(extName));
	 			var content = fileUtils.read(file);
	 			var baseLongName = baseName;
	 			//将html文件转换成js
	 			retContent.push(html2js(content , baseLongName , moduleName , '   '));
	 			retContent.push('   _template.'+baseName+' = artTemplate("'+baseLongName+'" , '+baseLongName+'.join(\'\'));\n');
	 		});
	 		retContent.push('   _template.helper = function(name, helper){');
			retContent.push('      artTemplate.helper(name, helper);');
			retContent.push('   }');
	 		retContent.push('   return _template;');
	 		retContent.push('});');
	 		//console.log(outfile);
	 		fileUtils.write(outfile , retContent.join('\n'));
	}
}

module.exports = TemplateTools;